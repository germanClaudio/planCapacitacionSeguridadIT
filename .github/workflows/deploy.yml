name: Deploy with protected codes

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # Permite ejecución manual

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Create encoded data file
      run: |
        # Crear directorio si no existe
        mkdir -p generated
        
        # Obtener los códigos del secret y convertirlos a array JavaScript
        CODES_ARRAY='${{ secrets.CODES_ARRAY }}'
        
        # Crear archivo JavaScript con los códigos ofuscados
        cat > generated/codes.js << EOF
        // Archivo generado automáticamente - NO EDITAR MANUALMENTE
        const CODES_DATA = "$CODES_ARRAY";
        export function getCodes() {
          return CODES_DATA.split(',');
        }
        EOF
        
        # También crear versión JSON
        echo '[' > generated/codes.json
        echo \"$CODES_ARRAY\" | sed 's/,/","/g' | sed 's/^/"/' | sed 's/$/"/' >> generated/codes.json
        echo ']' >> generated/codes.json
        
        # Mostrar confirmación (sin mostrar los códigos)
        echo "✓ Archivo de códigos generado exitosamente"
        echo "✓ Número de códigos procesados: $(echo \"$CODES_ARRAY\" | tr ',' '\n' | wc -l)"
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        keep_files: true  # Mantener archivos existentes

# name: Deploy to GitHub Pages

# on:
#   push:
#     branches: [ master ]
#   workflow_dispatch:

# jobs:
#   deploy:
#     runs-on: ubuntu-latest
    
#     steps:
#     - uses: actions/checkout@v3
    
#     - name: Generate Codes
#       run: |
#         mkdir -p generated
#         node scripts/generate-codes.js  # Tu script generador
        
#     - name: Deploy to GitHub Pages
#       uses: peaceiris/actions-gh-pages@v3
#       with:
#         github_token: ${{ secrets.GITHUB_TOKEN }}
#         publish_dir: ./